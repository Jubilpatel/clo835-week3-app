name: Deploy to ECR
# updated ECR Repo week3-1 01/22
on: 
  push:
    branches: [ master ]

jobs:
  
  build:
    
    name: Build Image
    runs-on: ubuntu-latest

   
    steps:

    - name: Check out code
      uses: actions/checkout@v4

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
      env:
        AWS_ACCESS_KEY_ID: ${{ ASIAQ3EGQMCEGNVM7N4B }}
        AWS_SECRET_ACCESS_KEY: ${{ yx/6X6JyQUJwmwIl21NPvre1ukPP/eohOSlx2x9j }}
        AWS_SESSION_TOKEN: ${{ IQoJb3JpZ2luX2VjEIj//////////wEaCXVzLXdlc3QtMiJHMEUCICdPFiRv0gQ4ppR/vy0+XwSSZP3wIm7YDbd/6YXe6lMWAiEAwZK1DuuGf6wMUq5dSevsM9+bBsl67wVma0NdxmtWPm0qrwIIURAAGgwwNTgyNjQxNTAxNTIiDNijL+ayf2esIyrEOCqMAkFf+5JC9zr60nfOlfhFfzzLpEvinfF0dHiQmkI29GGjZdHV9qFB2lWT68wN2GzDIDC/kbcAlYV6ipCiRBE/jHWlsHobKnYazLqNWA9CeSkPd3pKyZxQHq6ssloTKxdq8yPdyr+ueAdOVRkrA2P4PiJnFaVKorgtPoNowQg2gQQTJrr8iRLe4a1TLUYpEFhmmNx8bPF0w8/GjJ0GwZiXVwlXsFw/NM9WxGwrY8npAZLOGVk+39kvfQIVsmSKrLFnZdULrJuRUtTUMCDf9Al3HP4MBGhrfGEm/z3VaI77/Rbd700zmScKdEpGJ/LO2hCABgWUkck2/NNTGbUXSNN4b3f4ukPibhgKpssYB+Ywuu/TwQY6nQH9AiK5USGk1Q8UfeqJRJrfzTPEHCOjLGUcoXnJ2q/xixSalebsrvA3aDA3O138s3m8lD6T6HG+OLpsuxXEyyFMjJG4i57GODPjkQN67VDB49yBysCCPRHQsk1EQLSVwXVogvSBqgtohgexzAqf12c7DFkzfFoVo05ZC/UtXbop8YKR7yyRioyN1CWTj0oWBE4XxhzOV/a7Rc2v+AtG }}
        AWS_REGION: us-east-1

    - name: Build, test, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ 058264150152.dkr.ecr.us-east-1.amazonaws.com/clo835-week3 }}
        ECR_REPOSITORY: clo835-week3-1
        IMAGE_TAG: v0.1
      run: |
        cd Chapter02/kubia/
        ls -ltra
        # Docker build command
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        # Unit test
        docker run -d -p 80:8080 --name nodeapp $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker ps
        echo "Pause for 10 seconds to let container start"
        sleep 10
        curl localhost -vvv
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
